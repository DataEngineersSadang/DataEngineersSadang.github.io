{"componentChunkName":"component---src-templates-blog-post-js","path":"/jk/JK-04-kafka-quickstart/","result":{"data":{"site":{"siteMetadata":{"title":"Sadang DE Study"}},"markdownRemark":{"id":"e533be3c-6a1a-5a35-8e5a-b00f32828b2b","excerpt":"카프카를 간단하게 도커컴포즈를 활용하여 싱글노드 모드로 설치해본다. 도커컴포즈로 카프카 설치 카프카 버전은 참고하는 블로그에서 사용하는 2.13버전을 그대로 사용하였다. 현재는 작성일 기준으로 3.3.2가 최신이자 stable로 kafka.apache.org에 게시되었다. docker…","html":"<p>카프카를 간단하게 도커컴포즈를 활용하여 싱글노드 모드로 설치해본다.</p>\n<hr>\r\n<br><br>\n<h1>도커컴포즈로 카프카 설치</h1>\n<p>카프카 버전은 참고하는 블로그에서 사용하는 2.13버전을 그대로 사용하였다. 현재는 작성일 기준으로 3.3.2가 최신이자 stable로 <a href=\"https://kafka.apache.org/downloads\">kafka.apache.org</a>에 게시되었다.</p>\n<ul>\n<li><a href=\"https://pearlluck.tistory.com/638?category=935063\">docker-compose.yml</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ymldocker-compose.yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ymldocker-compose.yml line-numbers\"><code class=\"language-ymldocker-compose.yml\">version: &quot;2&quot;\r\nservices:\r\n  zookeeper:\r\n    container_name: local-zookeeper\r\n    image: wurstmeister/zookeeper:3.4.6\r\n    ports:\r\n      - &quot;2181:2181&quot;\r\n\r\n  kafka:\r\n    container_name: local-kafka\r\n    image: wurstmeister/kafka:2.12-2.3.0\r\n    depends_on:\r\n      - zookeeper\r\n    ports:\r\n      - &quot;9092:9092&quot;\r\n    environment:\r\n      KAFKA_ADVERTISED_HOST_NAME: 127.0.0.1\r\n      KAFKA_ADVERTISED_PORT: 9092\r\n      KAFKA_CREATE_TOPICS: &quot;twit_api_topic:1:1&quot; # topic name:partition numbers:replica numbers\r\n      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181\r\n    volumes:\r\n      - /var/run/docker.sock:/var/run/docker.sock</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>주키퍼 서버를 2181, 카프카 싱글클러스터 서버로 9092를 열어주었다.</p>\n<p>카프카 환경변수에는 <code class=\"language-text\">twit_api_topic</code>을 바로 생성하는 환경변수를 주입했다.</p>\n<p>topic은 카프카 브로커서버에서 아래와 같이 cli로도 생성할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cmd\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-cmd line-numbers\"><code class=\"language-cmd\">bash4.4# kafka-topics.sh --create --bootstrap-server localhost:9092 --topic twit_api_topic --partitions 1 --replication-factor 1</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>도커 컴포즈를 실행시키고, kafka 컨테이너에 터미널로 접근한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cmd\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-cmd line-numbers\"><code class=\"language-cmd\">$ docker-compose -f docker-compose.yml up  # 백그라운드 실행을 하려면, -d 데몬 옵션을 준다\r\n$ docker exec -it local-kafka bash  # local-kafka 컨테이너 bash 접근</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>카프카 컨테이너 접근하여 kafka 실행파일 설치한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cmd\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-cmd line-numbers\"><code class=\"language-cmd\">bash-4.4# cd /\r\nbash-4.4# wget https://archive.apache.org/dist/kafka/0.10.2.0/kafka_2.12-0.10.2.0.tgz\r\nbash-4.4# ls\r\nbin                      kafka                    media                    root                     sys\r\ndev                      kafka_2.12-0.10.2.0.tgz  mnt                      run                      tmp\r\netc                      lib                      opt                      sbin                     usr\r\nhome                     lib64                    proc                     srv                      var\r\n\r\nbash-4.4# tar -zxvf kafka_2.12-0.10.2.0.tgz\r\nbash-4.4# cd kafka_2.12-0.10.2.0/bin\r\nbash-4.4# kafka-topics.sh --list --bootstrap-server localhost:9092  # localhost:9092 포트에 생성된 topic 리스트 확인\r\ntwit_api_topic</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">kafka-topics.sh</code>로 도커컴포즈에서 주입한 topic이 잘 생성되었는지 확인되었다.</p>\n<blockquote>\n<p><code class=\"language-text\">bootstrap-server</code>로 열었으나, 주키퍼를 사용하는 경우에는 <code class=\"language-text\">kafka-topics.sh --list --zookeeper &lt;zookeeper_host:port></code>로 접근 가능하다고 한다. 두 차이는 추후에 정리해본다.</p>\n</blockquote>\n<h2>CLI Kafka 테스트</h2>\n<p>카프카를 테스트 하기위해 새로운 터미널을 열고 프로듀서, 컨슈머를 시작해보자.</p>\n<h3>프로듀서 만들기</h3>\n<p><code class=\"language-text\">kafka-console-producer.sh</code> 로 콘솔 테스트가 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cmd\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-cmd line-numbers\"><code class=\"language-cmd\">bash-4.4# kafka-console-producer.sh --broker-list localhost:9092 --topic twit_api_topic</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h3>컨슈머 만들기</h3>\n<div class=\"gatsby-highlight\" data-language=\"cmd\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-cmd line-numbers\"><code class=\"language-cmd\">bash-4.4# kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic twit_api_topic --from-beginning</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>위와 같이 작동한 후에 프로듀서 콘솔 창에 메시지를 입력하게 되면 컨슈머 콘솔에서 응답을 받을 수 있다.</p>\n<p>한글메시지는 간헐적으로 깨지기도 한다. 이를 방지하기 위해 인코딩 설정을 별도로 하기도 하고 메시지는 byte로 보내는 것이 좋다고 한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b98a3ac9132cffe4e541a3f99157dee6/86a74/test-console.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAeXk4oTj/8QAFhABAQEAAAAAAAAAAAAAAAAAEgAg/9oACAEBAAEFAnOeP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABcQAAMBAAAAAAAAAAAAAAAAAAADMyD/2gAIAQEABj8CowowozH/xAAaEAACAgMAAAAAAAAAAAAAAAAA8BHRASDh/9oACAEBAAE/Ico6QSyC3p//2gAMAwEAAgADAAAAEEMP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAEFAAAAAAAAAAAAAAAAAQARILHh8f/aAAgBAQABPxAK4Eg2MdQsf//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"test console\"\n        title=\"\"\n        src=\"/static/b98a3ac9132cffe4e541a3f99157dee6/828fb/test-console.jpg\"\n        srcset=\"/static/b98a3ac9132cffe4e541a3f99157dee6/ff44c/test-console.jpg 158w,\n/static/b98a3ac9132cffe4e541a3f99157dee6/a6688/test-console.jpg 315w,\n/static/b98a3ac9132cffe4e541a3f99157dee6/828fb/test-console.jpg 630w,\n/static/b98a3ac9132cffe4e541a3f99157dee6/0ede0/test-console.jpg 945w,\n/static/b98a3ac9132cffe4e541a3f99157dee6/86a74/test-console.jpg 1016w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>기존 토픽에 남은 레코드를 삭제하는 방법은 먼저 <code class=\"language-text\">config/server.properties</code>에서 delete.topic.enable=true를 추가한다.</p>\n<p>그리고 아래와 같이 topic의 레코드를 지워준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cmd\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-cmd line-numbers\"><code class=\"language-cmd\"># kafka-topics.sh -- --delete --topic {topicname}\r\nbash-4.4# kafka-topics.sh --bootstrap-server localhost:9092 --delete --topic twit_api_topic</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>다른 방법으로는 삭제 주기 옵션을(retention.ms) 1초 가량으로 줄이고 다시 복구한 후 시작하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cmd\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-cmd line-numbers\"><code class=\"language-cmd\">bash-4.4# kafka-topics.sh --bootstrap-server --alter --topic twit_api_topic --config retention.ms=1000</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h2>Kafka-python</h2>\n<p>카프카 프로듀서와 컨슈머 개발을 파이썬에서도 가능하다.</p>\n<p>카프카를 지원하는 파이썬 라이브러리로는 <code class=\"language-text\">kafka-python</code>, <code class=\"language-text\">confluent-kafka</code>가 대표적인 듯 하다.</p>\n<p>그 중에 github star가 더 많은 <code class=\"language-text\">kafka-python</code>을 활용하기로 해본다.</p>\n<p>우선 <code class=\"language-text\">kafka-python</code> 라이브러리를 설치하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span></span>pip <span class=\"token function\">install</span> kafka-python</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>앞서 도커컴포즈에 띄운 싱글노드 카프카 브로커에 간단한 메시지를 보내는 Producer 스크립트를 작성해본다.</p>\n<h3>python producer</h3>\n<div class=\"gatsby-highlight\" data-language=\"pythonproducer.py\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-pythonproducer.py line-numbers\"><code class=\"language-pythonproducer.py\">from kafka import KafkaProducer\r\n\r\n# kafka config\r\nproducer = KafkaProducer(bootstrap_servers=[&quot;localhost:9092&quot;])\r\n\r\n# 토픽 메시지 전송(메시지 전달시 보통 byte로 보내는 것이 좋음)\r\nproducer.send(topic=&quot;twit_api_topic&quot;, value=b&quot;python producer to kafka topic&quot;)\r\nproducer.flush()</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>재밌는건 DB에서 insert를 발생시키는 flush()를 명령어로 사용한다.\r\nsend 만으로는 큐에 저장하진 않는가보다. 추후에 구조를 알아보도록 해야겠다.</p>\n<p>위의 <code class=\"language-text\">producer.py</code>를 실행시키고 console consumer <code class=\"language-text\">kafka-console-consumer.sh</code>로 확인해보면 잘 들어와있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 485px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6992c43726c2bcf9ace5062077599587/0d3a1/test-console2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.39240506329114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAACABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAc6oIg//xAAWEAADAAAAAAAAAAAAAAAAAAAAARD/2gAIAQEAAQUCHP/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABgQAAIDAAAAAAAAAAAAAAAAAAABESFR/9oACAEBAAE/IR7Jen//2gAMAwEAAgADAAAAEHAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRABAQADAQAAAAAAAAAAAAAAAQARIWGR/9oACAEBAAE/EEMTGql2e3//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"test console2\"\n        title=\"\"\n        src=\"/static/6992c43726c2bcf9ace5062077599587/0d3a1/test-console2.jpg\"\n        srcset=\"/static/6992c43726c2bcf9ace5062077599587/ff44c/test-console2.jpg 158w,\n/static/6992c43726c2bcf9ace5062077599587/a6688/test-console2.jpg 315w,\n/static/6992c43726c2bcf9ace5062077599587/0d3a1/test-console2.jpg 485w\"\n        sizes=\"(max-width: 485px) 100vw, 485px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>python consumer</h3>\n<p>이 메시지를 받을 consumer 또한 파이썬으로 작성 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"pythonconsumer.py\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-pythonconsumer.py line-numbers\"><code class=\"language-pythonconsumer.py\">from kafka import KafkaConsumer\r\n\r\n# kafka config, producer와는 반대로 토픽을 먼저 정의\r\nconsumer = KafkaConsumer(&quot;twit_api_topic&quot;, bootstrap_servers=[&quot;localhost:9092&quot;])\r\n\r\n# consumer는 generator\r\nfor msg in consumer:\r\n    print(msg)</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">consumer.py</code>에 작성한 위 코드를 실행시키면, 무한루프가 돌면서 <code class=\"language-text\">producer.py</code>를 실행할 때 마다 데이터를 받아오게 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/554f2a67616c6122883175277451b148/9149e/python-consumer.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.87341772151899%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABzoEB/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhAAAwAAAAAAAAAAAAAAAAAAAAEQ/9oACAEBAAE/IRz/2gAMAwEAAgADAAAAEAAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGBABAQEBAQAAAAAAAAAAAAAAEQAxAXH/2gAIAQEAAT8QOmydjy//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"python consumer\"\n        title=\"\"\n        src=\"/static/554f2a67616c6122883175277451b148/828fb/python-consumer.jpg\"\n        srcset=\"/static/554f2a67616c6122883175277451b148/ff44c/python-consumer.jpg 158w,\n/static/554f2a67616c6122883175277451b148/a6688/python-consumer.jpg 315w,\n/static/554f2a67616c6122883175277451b148/828fb/python-consumer.jpg 630w,\n/static/554f2a67616c6122883175277451b148/9149e/python-consumer.jpg 699w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>받아오는 데이터는 ConsumerRecord 객체로 partition, offset, timestamp 등의 정보와 value에 메시지가 담긴다.</p>\n<p>ConsumerRecord 객체에 대한 내용과 자세한 과정은 다음 글에서 작성해보겠다.</p>\n<!-- 이제 twitter stream API를 Kafka로 stream으로 받아보자. -->\n<h3>참고</h3>\n<blockquote>\n<p><a href=\"https://pearlluck.tistory.com/638?category=935063\">https://pearlluck.tistory.com/638?category=935063</a></p>\n</blockquote>","frontmatter":{"title":"Apache Kafka 퀵스타트(quickstart)","date":"January 31, 2023","description":null,"tags":["JK","apache kafka"]}},"previous":{"fields":{"slug":"/jk/JK-04-kafka-intro/"},"frontmatter":{"title":"Apache Kafka 훑어보기"}},"next":null},"pageContext":{"id":"e533be3c-6a1a-5a35-8e5a-b00f32828b2b","previousPostId":"441c65bf-7d82-570d-9b3d-986f2b1f7638","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}